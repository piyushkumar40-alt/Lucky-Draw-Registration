<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbywwNqeEiCL9MFH_gCaBdOVPAuATkiXvMiDM3XPI72CD5YBVfHpZ1EoFvm9jdgfFAEEkw/exec";
    const instaURL = "https://www.instagram.com/makpowerofficial/";

    // Elements
    const overlay = document.getElementById('overlay');
    const loader = document.getElementById('loader');
    const popup = document.getElementById('popup');
    const redirectPopup = document.getElementById('redirectPopup');
    const popupTitle = document.getElementById('popupTitle');
    const popupText = document.getElementById('popupText');
    const countdownSpan = document.getElementById('countdown');
    const instaBtn = document.getElementById('instaBtn');
    
    // Form Elements
    const couponInput = document.getElementById('couponCode');
    const restOfForm = document.getElementById('restOfForm'); 
    
    const nameInput = document.getElementById('fullName');
    const mobileInput = document.getElementById('mobile');
    const mobileStatus = document.getElementById('mobileStatus');
    const shopInput = document.getElementById('shopName');
    const roleInput = document.getElementById('userRole');
    const districtInput = document.getElementById('district');
    const submitBtn = document.getElementById('submitBtn');

    // --- 1. COUPON CHECK (With Console Logs) ---
    function checkCoupon() {
        const val = couponInput.value.trim();
        if(val.length < 3) {
            showPopup("Input Error", "Please enter a valid Coupon Code.");
            return;
        }
        
        showLoader();
        console.log("Sending request for Coupon:", val); // Log 1: Sending

        fetch(`${scriptURL}?q=${encodeURIComponent(val)}`)
        .then(res => res.json())
        .then(data => {
            hideLoader();
            console.log("Server Response (Coupon Data):", data); // Log 2: Response

            if(data.valid) {
                showPopup("Coupon Verified", "Welcome! Code Accepted.");
                unlockForm(data.name || ""); 
            } else {
                console.warn("Coupon Invalid:", val); // Log 3: Invalid Warning
                showPopup("Invalid Code", "This coupon code was not found.");
                lockForm();
            }
        })
        .catch((error) => {
            hideLoader();
            console.error("Fetch Error:", error); // Log 4: Errors
            showPopup("Error", "Connection failed. Please check internet.");
        });
    }

    // --- 2. MOBILE DUPLICATE CHECK (With Console Logs) ---
    mobileInput.addEventListener('change', function() {
        const val = this.value.trim();
        const mobileVal = parseInt(val);

        if (isNaN(mobileVal) || mobileVal < 999999999 || mobileVal > 9999999999) {
            setMobileStatus("Invalid Format (Must be 10 digits)", "error");
            submitBtn.disabled = true;
            return;
        }

        setMobileStatus("Checking availability...", "checking");
        submitBtn.disabled = true;
        
        console.log("Checking Mobile Number:", val); // Log 1: Sending

        fetch(`${scriptURL}?m=${encodeURIComponent(val)}`)
        .then(res => res.json())
        .then(data => {
            console.log("Server Response (Mobile Check):", data); // Log 2: Response
            
            if(data.duplicate) {
                setMobileStatus("Number Already Registered!", "error");
                submitBtn.disabled = true;
            } else {
                setMobileStatus("Available", "success");
                submitBtn.disabled = false;
            }
        })
        .catch((error) => {
            console.error("Mobile Check Error:", error); // Log 3: Errors
            setMobileStatus("Check failed. Try again.", "error");
        });
    });

    function setMobileStatus(msg, type) {
        mobileStatus.innerText = msg;
        mobileStatus.className = "status-msg " + type;
    }

    // --- 3. SUBMISSION ---
    document.getElementById('collectionForm').addEventListener('submit', e => {
        e.preventDefault();
        
        if(mobileInput.value === "" || submitBtn.disabled) return;
        if(shopInput.value.trim() === "") { showPopup("Missing Info", "Enter Shop Name."); return; }
        if(roleInput.value === "") { showPopup("Missing Info", "Select Role."); return; }

        showLoader();
        
        let body = {
            name: nameInput.value,
            couponCode: couponInput.value,
            mobile: mobileInput.value,
            shop: shopInput.value,
            role: roleInput.value,
            district: districtInput.value,
            lat: document.getElementById('lat').value,
            long: document.getElementById('long').value
        };
        
        console.log("Submitting Form Data:", body); // Log 1: Data being sent

        fetch(scriptURL, {
            method: 'POST', mode: 'no-cors',
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            body: JSON.stringify(body)
        }).then(() => {
            console.log("Form Submitted Successfully (no-cors mode)"); // Log 2: Success
            hideLoader();
            startRedirectSequence(); 
            setTimeout(lockForm, 2000); 
        }).catch((error) => {
            console.error("Submission Error:", error); // Log 3: Error
            hideLoader();
            showPopup("Error", "Submission failed.");
        });
    });

    // --- 4. REDIRECT SEQUENCE ---
    function startRedirectSequence() {
        overlay.style.display = 'flex';
        popup.style.display = 'none';
        redirectPopup.style.display = 'block';
        
        instaBtn.disabled = true;
        instaBtn.innerText = "Please Wait...";
        let secondsLeft = 5;
        countdownSpan.innerText = `Button unlocks in ${secondsLeft}s...`;

        const timer = setInterval(() => {
            secondsLeft--;
            if(secondsLeft > 0) {
                countdownSpan.innerText = `Button unlocks in ${secondsLeft}s...`;
            } else {
                clearInterval(timer);
                countdownSpan.innerText = "Ready!";
                countdownSpan.style.color = "#27ae60"; 
                instaBtn.disabled = false;
                instaBtn.innerText = "Follow Us (Get Final Code)";
            }
        }, 1000);
    }

    function goToInsta() { window.location.href = instaURL; }

    // --- 5. UI UTILS ---
    function showLoader() { overlay.style.display = 'flex'; loader.style.display = 'block'; popup.style.display = 'none'; redirectPopup.style.display = 'none'; }
    function hideLoader() { loader.style.display = 'none'; }
    function showPopup(title, msg) { overlay.style.display = 'flex'; popup.style.display = 'block'; redirectPopup.style.display = 'none'; popupTitle.innerText = title; popupText.innerText = msg; }
    function closePopup() { overlay.style.display = 'none'; }

    function unlockForm(name) {
        restOfForm.classList.add('visible');
        if(name && name.length > 1) {
            nameInput.value = name;
            nameInput.disabled = true; 
        } else {
            nameInput.value = "";
            nameInput.placeholder = "Enter Full Name";
            nameInput.disabled = false; 
        }
        mobileInput.disabled = false;
        shopInput.disabled = false;
        roleInput.disabled = false;
        districtInput.disabled = false;
        submitBtn.disabled = false;

        mobileInput.placeholder = "Enter 10 Digit No...";
        shopInput.placeholder = "Enter Shop Name...";
        districtInput.placeholder = "Enter District...";
        roleInput.options[0].text = "Select Role...";
        setMobileStatus("", "");
    }

    function lockForm() {
        restOfForm.classList.remove('visible');
        nameInput.value = ""; nameInput.disabled = true;
        mobileInput.value = ""; mobileInput.disabled = true;
        shopInput.value = ""; shopInput.disabled = true;
        roleInput.value = ""; roleInput.disabled = true;
        districtInput.value = ""; districtInput.disabled = true;
        submitBtn.disabled = true; couponInput.value = "";
        
        mobileInput.placeholder = "Locked";
        shopInput.placeholder = "Locked";
        districtInput.placeholder = "Locked";
        roleInput.options[0].text = "Locked";
        setMobileStatus("", "");
    }

    window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('lat').value = pos.coords.latitude;
                    document.getElementById('long').value = pos.coords.longitude;
                    console.log("Location Captured:", pos.coords.latitude, pos.coords.longitude);
                }, 
                () => { console.log("GPS denied or unavailable"); }
            );
        }
    };
</script>
