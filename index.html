<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coupon Registration</title>
<style>
body{font-family:Arial;background:#f4f4f4;display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
.box{background:#fff;padding:30px;border-radius:10px;width:350px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
input,select,button{width:100%;padding:10px;margin-bottom:10px;border-radius:6px;border:1px solid #ccc}
button{background:#EE1C25;color:#fff;border:none;cursor:pointer}
button:disabled{background:#ccc}
.msg{font-size:12px;margin-top:-5px;margin-bottom:10px}
.success{color:green}
.error{color:red}
</style>
</head>

<body>

<div class="box">
<h3>Coupon Registration</h3>

<input type="text" id="couponCode" placeholder="Enter Coupon Code">
<button onclick="checkCoupon()">Verify Coupon</button>

<div id="formSection" style="display:none">

<input type="text" id="fullName" placeholder="Full Name">
<input type="tel" id="mobile" placeholder="Whatsapp Mobile">
<div id="mobileMsg" class="msg"></div>

<input type="text" id="shop" placeholder="Shop Name">

<select id="role">
<option value="">Select Role</option>
<option value="SS">SS</option>
<option value="Distributor">Distributor</option>
<option value="Dealer">Dealer</option>
</select>

<input type="text" id="district" placeholder="District">

<button id="submitBtn" onclick="submitForm()">Submit</button>

</div>

<div id="mainMsg" class="msg"></div>

</div>

<script>

const scriptURL = "YOUR_GOOGLE_SCRIPT_WEBAPP_URL_HERE";

let couponVerified = false;

// ============================
// Normalize Coupon
// ============================
function normalize(code){
  return code.replace(/\D/g,'');
}

// ============================
// Coupon Check
// ============================
function checkCoupon(){

  const raw = document.getElementById("couponCode").value;
  const code = normalize(raw);

  if(code.length < 6){
    showMsg("Enter valid coupon", "error");
    return;
  }

  fetch(`${scriptURL}?q=${code}`)
  .then(res => res.json())
  .then(data => {

    if(data.valid){
      couponVerified = true;
      showMsg("Coupon Verified", "success");
      document.getElementById("formSection").style.display = "block";
    }
    else{
      couponVerified = false;

      if(data.reason === "used"){
        showMsg("Coupon already used", "error");
      }else{
        showMsg("Invalid coupon", "error");
      }
    }
  })
  .catch(()=>{
    showMsg("Connection error", "error");
  });
}

// ============================
// Mobile Validation
// ============================
document.getElementById("mobile").addEventListener("blur", function(){

  const mobile = this.value.trim();
  const regex = /^[6-9]\d{9}$/;

  if(!regex.test(mobile)){
    setMobileMsg("Invalid 10 digit mobile", "error");
    return;
  }

  fetch(`${scriptURL}?m=${mobile}`)
  .then(res => res.json())
  .then(data => {
    if(data.duplicate){
      setMobileMsg("Mobile already registered", "error");
    }else{
      setMobileMsg("Mobile available", "success");
    }
  });
});

function setMobileMsg(msg,type){
  const el = document.getElementById("mobileMsg");
  el.innerText = msg;
  el.className = "msg " + type;
}

// ============================
// Submit Form
// ============================
function submitForm(){

  if(!couponVerified){
    showMsg("Verify coupon first", "error");
    return;
  }

  const name = document.getElementById("fullName").value.trim();
  const mobile = document.getElementById("mobile").value.trim();
  const shop = document.getElementById("shop").value.trim();
  const role = document.getElementById("role").value;
  const district = document.getElementById("district").value.trim();
  const couponCode = normalize(document.getElementById("couponCode").value);

  if(!name || !mobile || !shop || !role || !district){
    showMsg("All fields required", "error");
    return;
  }

  document.getElementById("submitBtn").disabled = true;

  fetch(scriptURL,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      name:name,
      couponCode:couponCode,
      mobile:mobile,
      shop:shop,
      role:role,
      district:district,
      lat:"",
      long:""
    })
  })
  .then(res=>res.json())
  .then(data=>{

    if(data.status==="success"){
      showMsg("Registration Successful", "success");
      document.getElementById("formSection").style.display="none";
    }else{
      showMsg(data.message, "error");
      document.getElementById("submitBtn").disabled=false;
    }

  })
  .catch(()=>{
    showMsg("Submission failed", "error");
    document.getElementById("submitBtn").disabled=false;
  });

}

// ============================
// Message Helper
// ============================
function showMsg(msg,type){
  const el = document.getElementById("mainMsg");
  el.innerText = msg;
  el.className = "msg " + type;
}

</script>

</body>
</html>
